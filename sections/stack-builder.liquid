{%- comment -%}
  Interactive Stack Builder Section
  Location: sections/stack-builder.liquid
  Purpose: AI-powered product stack recommendation tool
{%- endcomment -%}

<div class="stack-builder" id="stack-builder-{{ section.id }}">
  <div class="page-width">
    <div class="stack-builder__header">
      <h2 class="stack-builder__title brand-heading">
        {{ section.settings.title | default: "FIND YOUR PERFECT STACK." | escape }}
      </h2>
      {%- if section.settings.description != blank -%}
        <p class="stack-builder__description">
          {{ section.settings.description }}
        </p>
      {%- endif -%}
    </div>

    <div class="stack-builder__content">
      <div class="stack-builder__goals">
        {%- for block in section.blocks -%}
          {%- if block.type == 'goal' -%}
            <button 
              type="button"
              class="stack-builder__goal{% if forloop.first %} stack-builder__goal--active{% endif %}"
              data-goal-id="{{ block.settings.goal_id }}"
              data-stack-title="{{ block.settings.stack_title }}"
              data-collection="{{ block.settings.collection | escape }}"
            >
              <h3 class="stack-builder__goal-title brand-heading">{{ block.settings.title | escape }}</h3>
              <p class="stack-builder__goal-description">{{ block.settings.description }}</p>
            </button>
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div class="stack-builder__recommendation">
        <div class="stack-builder__stack">
          <h3 class="stack-builder__stack-title brand-heading" id="stack-title-{{ section.id }}">
            {{ section.blocks.first.settings.stack_title | default: "The Muscle Stack" }}
          </h3>
          <p class="stack-builder__stack-subtitle">Your AI-recommended foundation:</p>
          
          <div class="stack-builder__products" id="stack-products-{{ section.id }}">
            {%- assign first_goal = section.blocks.first -%}
            {%- assign any_rendered = false -%}
            {%- if first_goal and first_goal.settings.collection != blank -%}
              {%- assign goal_collection = collections[first_goal.settings.collection] -%}
              {%- if goal_collection != blank -%}
                {%- for product in goal_collection.products limit: 6 -%}
                  {%- assign any_rendered = true -%}
                  <div class="stack-builder__product-item">
                    {%- if product.featured_media != null -%}
                      <img 
                        src="{{ product.featured_media | image_url: width: 100 }}"
                        alt="{{ product.title | escape }}"
                        class="stack-builder__product-image"
                        loading="lazy"
                      >
                    {%- endif -%}
                    <div class="stack-builder__product-info">
                      <p class="stack-builder__product-name">{{ product.title }}</p>
                      <p class="stack-builder__product-price">{{ product.price | money }}</p>
                    </div>
                  </div>
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
            {%- unless any_rendered -%}
              <div class="stack-builder__product-item">
                <div class="stack-builder__product-image" style="width:100px;height:100px;background:rgba(255,255,255,.06);border-radius:.4rem;"></div>
                <div class="stack-builder__product-info">
                  <p class="stack-builder__product-name">Select a collection for this goal</p>
                  <p class="stack-builder__product-price">Choose a collection in the theme editor</p>
                </div>
              </div>
            {%- endunless -%}
          </div>

          <div class="stack-builder__footer">
            <p class="stack-builder__total" id="stack-total-{{ section.id }}">Total: <span id="stack-total-amount-{{ section.id }}">$0.00</span></p>
            <button type="button" id="add-stack-{{ section.id }}" class="button button--sloe-fit button--primary">
              Add Stack to Cart
            </button>
          </div>

          {%- if section.settings.show_waitlist_link -%}
            <p class="stack-builder__waitlist-text">
              Want a full workout plan? <a href="#" class="stack-builder__waitlist-link" data-modal-trigger="waitlist-modal">Join the AI Coach waitlist.</a>
            </p>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
</div>

{%- comment -%} Embed goal/product data for client-side rendering {%- endcomment -%}
<script type="application/json" id="stack-data-{{ section.id }}">
{
  {%- assign first = true -%}
  {%- for block in section.blocks -%}
    {%- if block.type == 'goal' -%}
      {%- if first == false -%},{%- endif -%}
      {%- assign first = false -%}
      "{{ block.settings.goal_id | default: 'goal_' | append: forloop.index }}": {
        "title": {{ block.settings.stack_title | default: 'Stack' | json }},
        "products": [
          {%- if block.settings.collection != blank -%}
            {%- assign goal_collection = collections[block.settings.collection] -%}
            {%- if goal_collection != blank -%}
              {%- assign pfirst = true -%}
              {%- for p in goal_collection.products limit: 6 -%}
                {%- assign v = p.selected_or_first_available_variant -%}
                {%- if pfirst == false -%},{%- endif -%}
                {%- assign pfirst = false -%}
                {
                  "variantId": {{ v.id | json }},
                  "priceCents": {{ v.price | times: 100 | divided_by: 100 | round: 0 }},
                  "title": {{ p.title | json }},
                  "image": {{ p.featured_media | image_url: width: 200 | json }}
                }
              {%- endfor -%}
            {%- endif -%}
          {%- endif -%}
        ]
      }
    {%- endif -%}
  {%- endfor -%}
}
</script>

<script>
  (function() {
    const stackBuilder = document.getElementById('stack-builder-{{ section.id }}');
    if (!stackBuilder) {
      console.warn('Stack builder element not found');
      return;
    }

    const goals = stackBuilder.querySelectorAll('.stack-builder__goal');
    const stackTitle = document.getElementById('stack-title-{{ section.id }}');
    const stackProducts = document.getElementById('stack-products-{{ section.id }}');
    const stackTotal = document.getElementById('stack-total-amount-{{ section.id }}');
    const addStackBtn = document.getElementById('add-stack-{{ section.id }}');
    const dataEl = document.getElementById('stack-data-{{ section.id }}');
    
    let stackData = {};
    try {
      const rawData = dataEl ? dataEl.textContent : '{}';
      console.log('Raw stack data:', rawData);
      stackData = JSON.parse(rawData);
      console.log('Stack data loaded:', stackData);
      console.log('Available goal IDs:', Object.keys(stackData));
    } catch (e) {
      console.error('Failed to parse stack data:', e);
      console.error('Raw content:', dataEl ? dataEl.textContent : 'no element');
    }
    
    const currencyCode = '{{ shop.currency }}';

    // Determine default goal id
    let currentGoalId = null;
    if (goals.length) {
      currentGoalId = goals[0].dataset.goalId;
      if (!stackData[currentGoalId]) {
        // fall back to first key in data
        currentGoalId = Object.keys(stackData)[0] || null;
      }
      console.log('Initial goal ID:', currentGoalId, 'Goals found:', goals.length);
    }

    function formatMoneyFromCents(cents) {
      try {
        if (window.Shopify && typeof window.Shopify.formatMoney === 'function') {
          return window.Shopify.formatMoney(cents, window.Shopify.currency && window.Shopify.currency.active);
        }
      } catch (e) {}
      return (cents / 100).toFixed(2) + ' ' + currencyCode;
    }

    function renderGoal(goalId) {
      console.log('Rendering goal:', goalId);
      const goal = stackData[goalId];
      if (!goal) {
        console.warn('Goal not found in data:', goalId);
        return;
      }
      console.log('Goal data:', goal);
      // Update title
      if (stackTitle) stackTitle.textContent = goal.title || '';
      // Render products
      let html = '';
      let totalCents = 0;
      if (Array.isArray(goal.products) && goal.products.length) {
        console.log('Rendering', goal.products.length, 'products');
        goal.products.forEach((p) => {
          totalCents += (p.priceCents || 0);
          html += `\n<div class="stack-builder__product-item">\n  ${p.image ? `<img src="${p.image}" alt="${p.title || ''}" class="stack-builder__product-image" loading="lazy">` : ''}\n  <div class="stack-builder__product-info">\n    <p class="stack-builder__product-name">${p.title || ''}</p>\n    <p class="stack-builder__product-price">${formatMoneyFromCents(p.priceCents || 0)}</p>\n  </div>\n</div>`;
        });
      } else {
        console.log('No products for this goal, showing placeholder');
        html = `\n<div class="stack-builder__product-item">\n  <div class="stack-builder__product-image" style="width:100px;height:100px;background:rgba(255,255,255,.06);border-radius:.4rem;"></div>\n  <div class="stack-builder__product-info">\n    <p class="stack-builder__product-name">Add products to this goal</p>\n    <p class="stack-builder__product-price">Use product handles in the section settings</p>\n  </div>\n</div>`;
      }
      if (stackProducts) stackProducts.innerHTML = html;
      if (stackTotal) stackTotal.textContent = formatMoneyFromCents(totalCents);
    }

    goals.forEach((goal, index) => {
      console.log(`Setting up goal ${index}:`, {
        goalId: goal.dataset.goalId,
        stackTitle: goal.dataset.stackTitle,
        collection: goal.dataset.collection,
        element: goal
      });
      goal.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('=== Goal Clicked ===');
        console.log('Clicked goal ID:', this.dataset.goalId);
        console.log('Current goal ID before:', currentGoalId);
        console.log('Data for this goal:', stackData[this.dataset.goalId]);
        goals.forEach(g => g.classList.remove('stack-builder__goal--active'));
        this.classList.add('stack-builder__goal--active');
        currentGoalId = this.dataset.goalId;
        console.log('Current goal ID after:', currentGoalId);
        renderGoal(currentGoalId);
      });
    });

    addStackBtn && addStackBtn.addEventListener('click', async () => {
      const goal = stackData[currentGoalId];
      if (!goal || !goal.products || !goal.products.length) {
        alert('No products configured for this goal. Please add product handles in the theme editor.');
        return;
      }
      addStackBtn.disabled = true;
      addStackBtn.textContent = 'Adding...';
      const items = goal.products.map(p => ({ id: p.variantId, quantity: 1 }));
      try {
        const res = await fetch('{{ routes.cart_add_url }}.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });
        if (res.ok) {
          window.location.href = '{{ routes.cart_url }}';
        } else {
          const data = await res.json();
          alert(data.description || 'Unable to add items to cart.');
          addStackBtn.disabled = false;
          addStackBtn.textContent = 'Add Stack to Cart';
        }
      } catch (e) {
        alert('Unable to add items to cart: ' + e.message);
        addStackBtn.disabled = false;
        addStackBtn.textContent = 'Add Stack to Cart';
      }
    });

    // Initial render
    if (currentGoalId) renderGoal(currentGoalId);

    // Legacy events removed; handled above
  })();
</script>

{% schema %}
{
  "name": "Stack Builder",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "FIND YOUR PERFECT STACK.",
      "label": "Section title"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "The Sloe Fit AI Coach builds a plan unique to you. What are you training for?",
      "label": "Description"
    },
    {
      "type": "checkbox",
      "id": "show_waitlist_link",
      "default": true,
      "label": "Show waitlist link"
    }
  ],
  "blocks": [
    {
      "type": "goal",
      "name": "Goal",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Goal title",
          "default": "Build Muscle"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Goal description",
          "default": "Maximize strength and hypertrophy."
        },
        {
          "type": "text",
          "id": "goal_id",
          "label": "Goal ID",
          "default": "build_muscle",
          "info": "Unique identifier (e.g., build_muscle)"
        },
        {
          "type": "text",
          "id": "stack_title",
          "label": "Stack title",
          "default": "The Muscle Stack"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Product Collection",
          "info": "Select a collection - products will automatically populate from it (up to 6 products)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stack Builder",
      "blocks": [
        {
          "type": "goal",
          "settings": {
            "title": "Build Muscle",
            "description": "Maximize strength and hypertrophy.",
            "goal_id": "build_muscle",
            "stack_title": "The Muscle Stack"
          }
        },
        {
          "type": "goal",
          "settings": {
            "title": "Lose Fat",
            "description": "Sustainable caloric deficit and nutrition.",
            "goal_id": "lose_fat",
            "stack_title": "The Fat Loss Stack"
          }
        },
        {
          "type": "goal",
          "settings": {
            "title": "Increase Energy",
            "description": "Optimize nutrition, sleep, and vitality.",
            "goal_id": "increase_energy",
            "stack_title": "The Energy Stack"
          }
        }
      ]
    }
  ]
}
{% endschema %}

